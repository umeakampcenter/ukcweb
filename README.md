# Umeå Kampcenter web
Web site for Umeå Kampcenter, a martial arts academy in Sweden.

## Getting started
These instructions will get you a copy of the project up and running on Windows.

### Prerequisites
Download Xampp with PHP 8+ and MySQL/MariaDB.

Download and install [Git](https://git-scm.com/download/win). Add the PATH to Git (usually C:\Program Files\Git\cmd).

Download the [Composer installer](https://getcomposer.org/download/) (Composer-Setup.exe). Make sure you add the PATH to Composer (usually C:\ProgramData\ComposerSetup\bin).

### Quick start

If everything is already set up, then you can just run `start.bat`

### Installation
Clone the repository to a folder on your drive using Git. If you are using PHPStorm this can be done by creating a project from Github.

Open up a Git bash console in your project folder and install the project dependencies:
```
composer install
```

Create a `.env` file from the example file and run:
```
php artisan key:generate
```

Install the frontend dependencies and start the build script:
```
npm i
npm run dev
```

Run the migrations and set up the Twill CMS:
```
php artisan twill:update --migrate
```

Seed the database with essential data:
```
php artisan db:seed
```

Create a Twill CMS user:
```
php artisan twill:superadmin <email> <password>
```

Run the built-in PHP web server:
```
php artisan serve --port=8080
```

### Access the application

The web application can be accessed at:
```
http://127.0.0.1:8080/
```

The Twill CMS is at (log in with the user created above):
```
http://127.0.0.1:8080/admin
```

## Project structure

### CMS forms

The routes in the CMS can be changed here: `routes\twill.php`

The CMS navbar/menu can be changed here: `app\Providers\AppServiceProvider.php`

The forms for editing a page type are defined in the Twill controllers here: `app\Http\Controllers\Twill`

These are generated by Twill when a new module is created.

The models for the different page types are here: `app\Models`

Form validation logic is located in requests: `app\Http\Requests\Twill`

### Views

The end user facing views are served with the controllers here: `app\Http\Controllers`

Routing is defined here: `routes\web.php`

Page layout/markup are located in blade files here: `resources\views`

### Database

Tables are created with code here: `database\migrations`

New migrations are generated by Twill when a new module is created.

Migrate or rollback with the following commands:
```
php artisan migrate
php artisan migrate:rollback
```

## Workflow

### New page template

A page template is represented in Twill CMS as a [Module](https://twillcms.com/docs/modules/index.html).

Use the following command to create a new page type that will be used for multiple pages:
```
php artisan twill:make:module moduleName -T
```

If there should only be one page of this kind then run this instead:
```
php artisan twill:make:singleton moduleName -T
```

Update the CMS menu here (looks different for modules and singletons): `app\Providers\AppServiceProvider.php`

Update the Twill controller, the migration and the model with the fields you want. Note that the the title is not part of the form, but it's "fillable".

Refresh the CMS and add some information.

Create a user facing controller:
```
php artisan make:controller
```

Copy the old blade template to `resources\views\` and replace the static content with view data from the DB. Make sure the controller points to the new blade file.

Update `routes\web.php` to load the page from the Twill instead of the old static pages.

### Using block editor in a page template

A block editor allows you to have a dynamic number of segements within a page. It can be used in both a module (multiple pages) or a singleton (one of a kind page).

If you add a block editor after the fact you have to modify both the model and the repository as well as the Twill controller to enable block editor.
- The Twill controller needs a `BlockEditor` in its `Form` to add the UI.
- The model needs traits to handle saving of block content.
- The repository needs traits to handle loading block content.

Note that the database part is handled implicitly (no extra fields needed in the migration etc.)

### Blocks

1. php artisan twill:make:componentBlock \SomeClass
2. Remove the \ from the class name.
3. Remove the double dot (..) from the render method.
4. Pick an icon using php artisan twill:list:icons
5. Set the name, icon and form fields in the block class.
6. Add the end-user facing markup to the blade file.
7. Add the block to a page module block editor. If the block class is SomeClass then the block name will be app-someclass.